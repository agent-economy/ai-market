# ì—ì´ì „íŠ¸ë§ˆì¼“ ì½”ë“œ ì ê²€ ë³´ê³ ì„œ
**ë‚ ì§œ:** 2026-02-04  
**ë¸Œëœì¹˜:** dev  
**ë¹Œë“œ:** âœ… í†µê³¼ (ìˆ˜ì • í›„ í™•ì¸ ì™„ë£Œ)

---

## ìš”ì•½

| ì‹¬ê°ë„ | ë°œê²¬ | ìˆ˜ì • | ë¯¸ìˆ˜ì • (ìˆ˜ë™ í•„ìš”) |
|--------|------|------|---------------------|
| ğŸ”´ CRITICAL | 3 | 3 | 0 |
| ğŸŸ  HIGH | 5 | 3 | 2 |
| ğŸŸ¡ MEDIUM | 11 | 1 | 10 |
| ğŸŸ¢ LOW | 7 | 0 | 7 |

---

## ğŸ”´ CRITICAL â€” ìˆ˜ì • ì™„ë£Œ

### 1. predictions API â€” DB ì»¬ëŸ¼ëª… ë¶ˆì¼ì¹˜ âœ… FIXED
**íŒŒì¼:** `src/app/api/predictions/route.ts`, `predictions/settle/route.ts`  
**ë¬¸ì œ:** `epoch_number` ì»¬ëŸ¼ìœ¼ë¡œ ì¿¼ë¦¬í•˜ì§€ë§Œ, ì‹¤ì œ economy_epochs í…Œì´ë¸”ì€ `epoch` ì»¬ëŸ¼ ì‚¬ìš©.  
ëª¨ë“  ì˜ˆì¸¡/ì •ì‚° ì¿¼ë¦¬ê°€ ë¹ˆ ê²°ê³¼ë¥¼ ë°˜í™˜í•˜ì—¬ ê¸°ëŠ¥ ìì²´ê°€ ì‘ë™í•˜ì§€ ì•Šì•˜ìŒ.  
**ìˆ˜ì •:** `epoch_number` â†’ `epoch`ë¡œ ì „ë¶€ êµì²´. `.single()` í¬ë˜ì‹œë„ `.limit(1)` + ë°°ì—´ ì ‘ê·¼ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ë³€ê²½.

### 2. economy/stats â€” ì—ëŸ¬ ì‹œ ê°€ì§œ ë°ì´í„° ë°˜í™˜ âœ… FIXED
**íŒŒì¼:** `src/app/api/economy/stats/route.ts`  
**ë¬¸ì œ:** catch ë¸”ë¡ì—ì„œ í•˜ë“œì½”ë”©ëœ ê°€ì§œ í†µê³„(`totalAgents: 5, totalBalance: 498` ë“±)ë¥¼ 200 OKë¡œ ë°˜í™˜.  
DB ì¥ì•  ì‹œì—ë„ ì •ìƒì²˜ëŸ¼ ë³´ì´ê²Œ ë¨ â€” ë””ë²„ê¹… ë¶ˆê°€ëŠ¥.  
**ìˆ˜ì •:** ì •ìƒì ì¸ 500 ì—ëŸ¬ ì‘ë‹µìœ¼ë¡œ êµì²´. `.single()` â†’ `.limit(1)` + null ì•ˆì „ ì ‘ê·¼.

### 3. economy-engine â€” ì—í¬í¬ ë™ì‹œ ì‹¤í–‰ ê°€ëŠ¥ (Race Condition) âœ… FIXED
**íŒŒì¼:** `src/lib/economy-engine.ts`  
**ë¬¸ì œ:** ë‘ Cron ìš”ì²­ì´ ë™ì‹œì— `getNextEpochNumber()` í˜¸ì¶œ â†’ ê°™ì€ ì—í¬í¬ ë²ˆí˜¸ íšë“ â†’ ì¤‘ë³µ ì‹¤í–‰ ê°€ëŠ¥.  
20ê°œ ì—ì´ì „íŠ¸ Ã— Gemini API í˜¸ì¶œì´ 2ë°°ë¡œ ë°œìƒí•˜ë©° ë°ì´í„° ì˜¤ì—¼.  
**ìˆ˜ì •:** (1) in-memory lock (`_epochRunning` flag + try/finally í•´ì œ), (2) DB ë ˆë²¨ ì¤‘ë³µ ì²´í¬ (ê¸°ì¡´ ì—í¬í¬ ì¡´ì¬ ì—¬ë¶€ í™•ì¸)

---

## ğŸŸ  HIGH â€” ìˆ˜ì • ì™„ë£Œ

### 4. admin/usage â€” í•˜ë“œì½”ë”©ëœ ê¸°ë³¸ ì‹œí¬ë¦¿ âœ… FIXED
**íŒŒì¼:** `src/app/api/admin/usage/route.ts`  
**ë¬¸ì œ:** `ADMIN_SECRET || 'agentmarket2026'` â€” env ë¯¸ì„¤ì • ì‹œ ëˆ„êµ¬ë‚˜ ê´€ë¦¬ì ì ‘ê·¼ ê°€ëŠ¥.  
**ìˆ˜ì •:** ê¸°ë³¸ê°’ ì œê±°. env ë¯¸ì„¤ì • ì‹œ 503 ë°˜í™˜. Authorization í—¤ë” ì§€ì› ì¶”ê°€.

### 5. .env.example ëˆ„ë½ âœ… FIXED
**íŒŒì¼:** `.env.example`  
**ë¬¸ì œ:** ì‹¤ì œ ì‚¬ìš©í•˜ëŠ” `CRON_SECRET`, `SOLANA_WALLET_SECRET_KEY`, `SOLANA_WALLET_PUBLIC_KEY`, `ADMIN_SECRET`ê°€ ëˆ„ë½.  
**ìˆ˜ì •:** 4ê°œ ë³€ìˆ˜ ì¶”ê°€.

### 6. Gemini API íƒ€ì„ì•„ì›ƒ ì—†ìŒ âœ… FIXED
**íŒŒì¼:** `src/lib/economy-engine.ts` â†’ `callGemini()`  
**ë¬¸ì œ:** Gemini API ì‘ë‹µì´ ë¬´í•œ ëŒ€ê¸° ê°€ëŠ¥. 20ê°œ ë³‘ë ¬ í˜¸ì¶œì´ ëª¨ë‘ í–‰ â†’ 60ì´ˆ Vercel í•œë„ ì´ˆê³¼.  
**ìˆ˜ì •:** `AbortController`ë¡œ 15ì´ˆ íƒ€ì„ì•„ì›ƒ ì¶”ê°€.

---

## ğŸŸ  HIGH â€” ìˆ˜ë™ ì¡°ì¹˜ í•„ìš”

### 7. Kakao ì¸ì¦ â€” ì¿ í‚¤ì— ìœ ì € ì •ë³´ í‰ë¬¸ ì €ì¥
**íŒŒì¼:** `src/app/api/auth/kakao/callback/route.ts`  
**ë¬¸ì œ:** `httpOnly: false`ë¡œ ìœ ì € ì •ë³´ë¥¼ JSON ì¿ í‚¤ì— ì €ì¥. í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì„ì˜ ìˆ˜ì • ê°€ëŠ¥.  
â†’ ë‹¤ë¥¸ ì‚¬ìš©ì IDë¡œ ë³€ì¡°í•˜ë©´ íƒ€ì¸ì˜ ë² íŒ… ë‚´ì—­ ì ‘ê·¼ ê°€ëŠ¥.  
**ê¶Œì¥:** JWT ì„œëª… ì¶”ê°€ ë˜ëŠ” Supabase auth ì—°ë™. ìµœì†Œí•œ `httpOnly: true` + ì„œë²„ ì‚¬ì´ë“œ ì„¸ì…˜ ê²€ì¦.

### 8. predictions POST â€” í¬ì¸íŠ¸ ì°¨ê° Race Condition
**íŒŒì¼:** `src/app/api/predictions/route.ts`  
**ë¬¸ì œ:** í¬ì¸íŠ¸ ì¡°íšŒ â†’ ì”ì•¡ í™•ì¸ â†’ ì°¨ê° ì‚¬ì´ì— ë™ì‹œ ìš”ì²­ ì‹œ ì´ì¤‘ ì°¨ê° ê°€ëŠ¥.  
ì˜ˆ: 1000P ì”ì•¡, 500P ë² íŒ… 2ê±´ ë™ì‹œ â†’ ì”ì•¡ 0Pë¡œ ê°ì†Œ ëŒ€ì‹  ê°ê° 500P ì°¨ê° ì‹œë„.  
**ê¶Œì¥:** Supabase RPCë¡œ atomic ì°¨ê° (`UPDATE user_points SET points = points - $1 WHERE points >= $1`)

---

## ğŸŸ¡ MEDIUM

### 9. economy/reports â€” ì¸ì¦ ì—†ìŒ
Gemini APIë¥¼ 20ê°œ ì—ì´ì „íŠ¸ì— ëŒ€í•´ í˜¸ì¶œí•˜ëŠ” ë¹„ì‹¼ ì—”ë“œí¬ì¸íŠ¸ì¸ë°, ëˆ„êµ¬ë‚˜ í˜¸ì¶œ ê°€ëŠ¥.  
**ê¶Œì¥:** rate limiting ë˜ëŠ” `ECONOMY_EPOCH_SECRET` ì¸ì¦ ì¶”ê°€.

### 10. agents/register, agents/registry â€” íŒŒì¼ì‹œìŠ¤í…œ ì €ì¥
Vercel serverless í™˜ê²½ì—ì„œ `data/agents.json` íŒŒì¼ I/O â†’ ë°°í¬ë§ˆë‹¤ ì´ˆê¸°í™”, ì¸ìŠ¤í„´ìŠ¤ ê°„ ê³µìœ  ë¶ˆê°€.  
**ê¶Œì¥:** Supabase í…Œì´ë¸”ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜.

### 11. challengeStore â€” in-memory Map
`src/app/api/agents/registry/challenge/route.ts`ì˜ ì±Œë¦°ì§€ ì €ì¥ì†Œê°€ ë©”ëª¨ë¦¬ ê¸°ë°˜.  
Vercel ì¸ìŠ¤í„´ìŠ¤ ê°„ ê³µìœ  ì•ˆ ë¨. Cold startë§ˆë‹¤ ì´ˆê¸°í™”.  
**ê¶Œì¥:** Redis ë˜ëŠ” Supabase ì„ì‹œ í…Œì´ë¸”.

### 12. Kakao OAuth â€” í•˜ë“œì½”ë”©ëœ redirect URI
`agentmarket.kr`ë¡œ ê³ ì • â†’ localhost, staging í™˜ê²½ì—ì„œ ì‘ë™ ì•ˆ í•¨.  
**ê¶Œì¥:** `process.env.NEXT_PUBLIC_BASE_URL` í™˜ê²½ë³€ìˆ˜ í™œìš©.

### 13. predictions/settle â€” `prevBalance` í•˜ë“œì½”ë”©
`const prevBalance = 100;` â€” ë§¤ ì—í¬í¬ë§ˆë‹¤ $100 ëŒ€ë¹„ë¡œ ë¹„êµí•˜ë¯€ë¡œ ì •ì‚° ê²°ê³¼ê°€ ë¶€ì •í™•.  
**ê¶Œì¥:** `economy_epochs` í…Œì´ë¸”ì— ì—ì´ì „íŠ¸ë³„ ì‹œì‘ ì”ì•¡ ì €ì¥í•˜ê±°ë‚˜, ì´ì „ ì—í¬í¬ ê±°ë˜ì—ì„œ ì‚°ì¶œ.

### 14. economy-engine â€” crisis ì´ë²¤íŠ¸ íˆ¬ëª…ì„± ë¶€ì¡±
crisis ì´ë²¤íŠ¸ì—ì„œ ëœë¤ ì—ì´ì „íŠ¸ $5 ì†ì‹¤ì´ `balanceUpdates`ì—ë§Œ ë°˜ì˜ë˜ê³  íŠ¸ëœì­ì…˜ ê¸°ë¡ ì—†ìŒ.  
â†’ ì‚¬ìš©ìì—ê²Œ ë³´ì´ì§€ ì•ŠëŠ” ìê¸ˆ ë³€ë™.  
**ê¶Œì¥:** `economy_transactions`ì— `type: 'crisis_loss'` íŠ¸ëœì­ì…˜ ì¶”ê°€.

### 15. chat/route.ts â€” ì‹œê°„ë‹¹ rate limit ì—†ìŒ
stream ì—”ë“œí¬ì¸íŠ¸ì™€ ë‹¬ë¦¬ per-minuteë§Œ ìˆê³  per-hour ì²´í¬ ì—†ìŒ.  
**ì˜í–¥:** ë‚®ìŒ (ë‘˜ ë‹¤ ê°™ì€ ê¸°ëŠ¥, streamì´ ì£¼ë ¥ ì‚¬ìš©)

### 16. CORS í—¤ë” ë¯¸ì„¤ì •
API ë¼ìš°íŠ¸ì— ëª…ì‹œì  CORS í—¤ë” ì—†ìŒ. next.config.tsì˜ ë³´ì•ˆ í—¤ë”ëŠ” CORSê°€ ì•„ë‹˜.  
í˜„ì¬ ê°™ì€ ë„ë©”ì¸ì—ì„œë§Œ í˜¸ì¶œí•˜ë¯€ë¡œ ë¬¸ì œ ì—†ì§€ë§Œ, ì™¸ë¶€ ì—ì´ì „íŠ¸ê°€ API í˜¸ì¶œ ì‹œ ì°¨ë‹¨ë¨.  
**ê¶Œì¥:** í•„ìš” ì‹œ `Access-Control-Allow-Origin` ì¶”ê°€.

### 17. Supabase RLS ì˜ì¡´ì„±
economy-engine.tsì˜ `getSupabase()`ê°€ anon key + ë¹ˆ ì¿ í‚¤ë¡œ ì ‘ê·¼ â†’ RLSê°€ anon ì ‘ê·¼ì„ í—ˆìš©í•´ì•¼ í•¨.  
ë³„ë„ service_role keyë¥¼ ì“°ëŠ” ê²Œ ë” ì•ˆì „.

### 18. predictions POST â€” userId ê²€ì¦ ì—†ìŒ
userIdê°€ ì•„ë¬´ ë¬¸ìì—´ì´ë‚˜ ê°€ëŠ¥. ì‹¤ì œ Kakao ì¸ì¦ ìœ ì €ì¸ì§€ í™•ì¸ ì•ˆ í•¨.

### 19. predictions POST â€” rate limiting ì—†ìŒ
ë² íŒ… ì—”ë“œí¬ì¸íŠ¸ì— rate limit ì—†ìŒ â†’ ìŠ¤íŒ¸ ê°€ëŠ¥.

---

## ğŸŸ¢ LOW

### 20. rate-limit â€” serverless í•œê³„
in-memory `Map` ê¸°ë°˜ â†’ Vercel ì¸ìŠ¤í„´ìŠ¤ ê°„ ê³µìœ  ë¶ˆê°€. ê¸°ë³¸ ë°©ì–´ë§Œ ë¨.

### 21. agents/register â€” rate limiting ì—†ìŒ
êµ¬ API. ì‹¤ì‚¬ìš© ì ì„ ë“¯í•˜ì§€ë§Œ ë°©ì–´ ì—†ìŒ.

### 22. chat/route.ts vs chat/stream â€” ì½”ë“œ ì¤‘ë³µ
ê±°ì˜ ê°™ì€ ë¡œì§ì´ ë‘ íŒŒì¼ì— ì¡´ì¬. DRY ì›ì¹™ ìœ„ë°˜.

### 23. economy-engine â€” ê°œë³„ DB insert
executeTransactionsì—ì„œ íŠ¸ëœì­ì…˜ë§ˆë‹¤ ê°œë³„ INSERT â†’ 20ê°œ ì—ì´ì „íŠ¸ ì‹œ ë‹¤ìˆ˜ DB í˜¸ì¶œ.  
ë°°ì¹˜ insertë¡œ ìµœì í™” ê°€ëŠ¥.

### 24. setInterval in challenge/route.ts
serverless í™˜ê²½ì—ì„œ setIntervalì€ cold startë§ˆë‹¤ ì¬ì‹œì‘. ì‹¤ì§ˆì  cleanup ë¶ˆí™•ì‹¤.

### 25. next.config.ts â€” metadataBase ë¯¸ì„¤ì •
ë¹Œë“œ ê²½ê³ : OG ì´ë¯¸ì§€ ë©”íƒ€ë°ì´í„° base URL ë¯¸ì„¤ì •.

### 26. economy-engine â€” `!` non-null assertions
`balanceUpdates.get(id)!` ë“± ì—¬ëŸ¬ ê³³ì—ì„œ non-null assertion ì‚¬ìš©. ë°©ì–´ì  ì½”ë”© ê¶Œì¥.

---

## âœ… ì˜ ëœ ë¶€ë¶„

- **chat/stream**: ë³´ì•ˆ ë ˆì´ì–´ ì¶©ì‹¤ (origin ê²€ì¦, ë¶„/ì‹œê°„ rate limit, ì¼ì¼ í•œë„, input sanitization, history í¬ê¸° ì œí•œ)
- **economy/epoch**: ì¸ì¦ ì²´í¬ ê¼¼ê¼¼ (Header + Body + CRON_SECRET ë‹¤ì¤‘ ì§€ì›)
- **next.config.ts**: ë³´ì•ˆ í—¤ë” ì„¤ì • ìš°ìˆ˜ (HSTS, X-Frame-Options, CSP ê¸°ë°˜ ë“±)
- **economy-engine**: Gemini í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ graceful fallback (`WAIT` ê²°ì •ìœ¼ë¡œ ëŒ€ì²´) âœ…
- **economy-engine**: JSON íŒŒì‹± ì—ëŸ¬ í•¸ë“¤ë§ âœ… (`parseDecision`ì—ì„œ catch â†’ WAIT)
- **ì—ì´ì „íŠ¸ ìƒì„¸/ë¦¬ë”ë³´ë“œ**: ì—ëŸ¬ í•¸ë“¤ë§ ì ì ˆ

---

## ìˆ˜ì •ëœ íŒŒì¼ ëª©ë¡

```
src/app/api/predictions/route.ts          â€” epoch_number â†’ epoch, .single() ì•ˆì „í™”
src/app/api/predictions/settle/route.ts   â€” epoch_number â†’ epoch, .single() ì•ˆì „í™”
src/app/api/economy/stats/route.ts        â€” ê°€ì§œ ë°ì´í„° ì œê±°, .single() ì•ˆì „í™”
src/app/api/admin/usage/route.ts          â€” í•˜ë“œì½”ë”© ì‹œí¬ë¦¿ ì œê±°, Authorization í—¤ë” ì§€ì›
src/lib/economy-engine.ts                 â€” ì—í¬í¬ lock, DB ì¤‘ë³µ ì²´í¬, Gemini 15s íƒ€ì„ì•„ì›ƒ
.env.example                              â€” ëˆ„ë½ ë³€ìˆ˜ 4ê°œ ì¶”ê°€
```
